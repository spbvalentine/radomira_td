<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>История обращений</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- DataTables Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.3.4/css/dataTables.bootstrap5.min.css">

    <!-- Responsive DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/3.0.2/css/responsive.bootstrap5.min.css">

    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <style>
      #loader {
        transition: all 0.3s ease-in-out;
        opacity: 1;
        visibility: visible;
        position: fixed;
        height: 100vh;
        width: 100%;
        background: #fff;
        z-index: 90000;
      }

      #loader.fadeOut {
        opacity: 0;
        visibility: hidden;
      }

      .spinner {
        width: 40px;
        height: 40px;
        position: absolute;
        top: calc(50% - 20px);
        left: calc(50% - 20px);
        background-color: #333;
        border-radius: 100%;
        -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
        animation: sk-scaleout 1.0s infinite ease-in-out;
      }

      @-webkit-keyframes sk-scaleout {
        0% { -webkit-transform: scale(0) }
        100% {
          -webkit-transform: scale(1.0);
          opacity: 0;
        }
      }

      @keyframes sk-scaleout {
        0% {
          -webkit-transform: scale(0);
          transform: scale(0);
        }
        100% {
          -webkit-transform: scale(1.0);
          transform: scale(1.0);
          opacity: 0;
        }
      }

      /* Информационная строка */
      div.dataTables_wrapper div.dataTables_info {
        padding: 0.5rem 0;
        font-size: 0.875rem;
        color: #6c757d;
      }

      /* Курсор для строк */
      #dataTable tbody tr {
        cursor: pointer;
      }

      #dataTable tbody tr:hover {
        background-color: #f8f9fa;
      }

      /* Запрещаем перенос в ячейках по умолчанию */
      #dataTable td, #dataTable th {
        white-space: nowrap;
      }

      /* Скрываем стандартную иконку разворота */
      table.dataTable.dtr-inline.collapsed > tbody > tr > td:first-child:before,
      table.dataTable.dtr-inline.collapsed > tbody > tr > th:first-child:before,
      table.dataTable.dtr-inline.collapsed > tbody > tr.parent > td:first-child:before,
      table.dataTable.dtr-inline.collapsed > tbody > tr.parent > th:first-child:before {
        display: none !important;
      }

      /* Выравнивание содержимого ячеек по центру */
        #dataTable td.test,
        #dataTable th {
            text-align: center;
            vertical-align: middle;
        }

      /* Стиль для уведомлений */
      .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 9999;
      }
      .toast {
        min-width: 250px;
        opacity: 0;
        transform: translateY(20px);
        animation: slideIn 0.3s forwards;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      }
      @keyframes slideIn {
        to { opacity: 1; transform: translateY(0); }
      }
      .toast.hide {
        animation: fadeOut 0.3s forwards;
      }
      @keyframes fadeOut {
        to { opacity: 0; transform: translateY(20px); }
      }

      /* Стиль кнопок действий */
      .action-btn {
        margin: 0 2px;
        padding: 4px 8px;
        font-size: 14px;
        border-radius: 4px;
        transition: all 0.2s;
      }

      .btn-edit {
        background-color: #0d6efd;
        color: white;
        border: 1px solid #0d6efd;
      }

      .btn-edit:hover {
        background-color: #0b5ed7;
        border-color: #0a58ca;
      }

      .btn-delete {
        background-color: #dc3545;
        color: white;
        border: 1px solid #dc3545;
      }

      .btn-delete:hover {
        background-color: #bb2d3b;
        border-color: #b02a37;
      }

      /* Модальное окно подтверждения */
      .modal-confirm {
        z-index: 10000;
      }

      .modal-confirm .modal-content {
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      }

      .modal-confirm .modal-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem 1.5rem;
      }

      .modal-confirm .modal-body {
        padding: 1.5rem;
      }

      .modal-confirm .modal-footer {
        padding: 1rem 1.5rem;
        border-top: 1px solid #dee2e6;
      }
    </style>

    <script defer="defer" src="/static/adminator/main.js"></script>

      <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  </head>
  <body class="app">
    <div id="loader">
      <div class="spinner"></div>
    </div>

    <script>
      window.addEventListener('load', function load() {
        const loader = document.getElementById('loader');
        setTimeout(function() {
          loader.classList.add('fadeOut');
        }, 300);
      });
    </script>

    <div>
      <!-- #Left Sidebar ==================== -->
      <div class="sidebar">
        <div class="sidebar-inner">
          {% include 'adminator/logo.html' %}
          {% include 'adminator/menu.html' %}
        </div>
      </div>

      <!-- #Main ============================ -->
      <div class="page-container">
        {% include 'adminator/topbar.html' %}

        <main class="main-content bgc-grey-100">
          <div id="mainContent">
            <div class="container-fluid">
              <div class="row">
                <div class="col-md-12">
                  <div class="bgc-white bd bdrs-3 p-20 mB-20">
                    <h4 class="c-grey-900 mB-20">История обращений</h4>

                    <table id="dataTable" class="table table-striped table-bordered nowrap" cellspacing="0" width="100%">
                      <thead></thead>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>

        {% include 'adminator/bottombar.html' %}
      </div>
    </div>

    <!-- Модальное окно подтверждения удаления -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-confirm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Подтверждение удаления</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Вы уверены, что хотите удалить обращение <strong id="deleteRecordId"></strong>?</p>
            <p class="text-danger">Это действие нельзя отменить.</p>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Удалить</button>
          </div>
        </div>
      </div>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Bootstrap Bundle JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/2.3.4/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.3.4/js/dataTables.bootstrap5.js"></script>

    <!-- Responsive DataTables JS -->
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/3.0.2/js/responsive.bootstrap5.min.js"></script>

    <script>
      $(document).ready(function() {
        let deleteRecordId = null;
        const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));

        const table = $('#dataTable').DataTable({
            "processing": true,
            "serverSide": true,
            "responsive": {
                details: {
                    type: 'column',
                    target: 'tr'
                }
            },
            "autoWidth": false,
            "ajax": {
                "url": "/api/calls/",
                "dataSrc": function(json) {
                    json.recordsTotal = json.recordsTotal;
                    json.recordsFiltered = json.count;
                    return json.results;
                }
            },
            "columns": [
                { "data": "id", "title": "ID", "className": "all" },
                {
                    "data": "call_date",
                    "title": "Дата",
                    "className": "all",
                    "render": function(data, type, row) {
                        if (!data) return "—";
                        const date = new Date(data);
                        // Проверка на валидность даты
                        if (isNaN(date.getTime())) return data; // если не распарсилось — вернём как есть
                        const day = String(date.getDate()).padStart(2, '0');
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}.${month}.${year}`;
                    }
                },
                { "data": "call_time", "title": "Время", "className": "all" },
                {
                    "data": "duration",
                    "title": "Продолжительность",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "all"
                },
                {
                    "data": "gender",
                    "title": "Пол",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-tablet-l"
                },
                {
                    "data": "age_group",
                    "title": "Возраст",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-tablet-l"
                },
                {
                    "data": "marital_status",
                    "title": "Семейное положение",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "social_status",
                    "title": "Социальное положение",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "problem",
                    "title": "Проблема",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "problem_duration",
                    "title": "Длительность проблемы",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "emotional_state",
                    "title": "Эмоц. состояние",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "crisis_situation",
                    "title": "Кризисность",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "help_provided",
                    "title": "Помощь",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "frequency",
                    "title": "Периодичность",
                    "render": function(data, type, row) {
                        return data ? data.description : "—";
                    },
                    "className": "min-desktop-l"
                },
                {
                    "data": "consultant",
                    "title": "Консультант",
                    "render": function(data, type, row) {
                        return data ? data.full_name || (data.first_name + ' ' + data.last_name) || data.username || "—" : "—";
                    },
                    "className": "all"
                },
                // ✅ Колонка с кнопками действий
                {
                    "data": null,
                    "title": "Действия",
                    "orderable": false,
                    "searchable": false,
                    "className": "all",
                    "render": function(data, type, row) {
                        return `
                            <div class="d-flex gap-1 justify-content-center align-items-center">
                                <button class="btn btn-edit action-btn" title="Редактировать" data-id="${row.id}">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">edit</span>
                                </button>
                                <button class="btn btn-delete action-btn" title="Удалить" data-id="${row.id}">
                                    <span class="material-icons" style="font-size: 16px; vertical-align: middle;">delete</span>
                                </button>
                            </div>
                        `;
                    }
                }
            ],
            "language": {
                "processing": "Загрузка...",
                "search": "Поиск:",
                "lengthMenu": "Показать _MENU_ записей",
                "info": "Показано с _START_ до _END_ из _TOTAL_",
                "infoEmpty": "Нет данных",
                "infoFiltered": "(отфильтровано из _MAX_ записей)",
                "loadingRecords": "Загрузка...",
                "zeroRecords": "Ничего не найдено",
                "emptyTable": "Таблица пуста",
                "paginate": {
                    "first": "« Первая",
                    "previous": "‹ Назад",
                    "next": "Вперёд ›",
                    "last": "Последняя »"
                },
                "aria": {
                    "sortAscending": ": активировать для сортировки по возрастанию",
                    "sortDescending": ": активировать для сортировки по убыванию"
                }
            },
            "pageLength": 10,
            "lengthMenu": [10, 25, 50, 100],
            "order": [[0, "desc"]]
        });

        // Обработчик клика по кнопке "Редактировать"
        $('#dataTable tbody').on('click', '.btn-edit', function(e) {
            e.stopPropagation();
            const id = $(this).data('id');
            if (id) {
                window.open(`/calls/${id}/`, '_blank');
            }
        });

        // Обработчик клика по кнопке "Удалить"
        $('#dataTable tbody').on('click', '.btn-delete', function(e) {
            e.stopPropagation();
            const id = $(this).data('id');
            if (id) {
                deleteRecordId = id;
                $('#deleteRecordId').text('#' + id);
                deleteModal.show();
            }
        });

        // Обработчик подтверждения удаления
        $('#confirmDeleteBtn').on('click', function() {
            if (!deleteRecordId) return;

            $.ajax({
                url: `/api/calls/${deleteRecordId}/`,
                type: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                },
                success: function() {
                    showToast(`Обращение #${deleteRecordId} удалено`, 'success');
                    table.ajax.reload(null, false);
                    deleteModal.hide();
                },
                error: function(xhr) {
                    let errorMsg = "Неизвестная ошибка";
                    if (xhr.responseJSON && xhr.responseJSON.detail) {
                        errorMsg = xhr.responseJSON.detail;
                    } else if (xhr.responseText) {
                        errorMsg = xhr.responseText;
                    }
                    showToast(`Ошибка: ${errorMsg}`, 'danger');
                    deleteModal.hide();
                }
            });
        });

        // Универсальная функция уведомлений
        function showToast(message, type = "success") {
          const toast = document.createElement("div");
          toast.className = `toast align-items-center text-white bg-${type === "danger" ? "error" : type} border-0 show mb-2 p-3 rounded shadow`;
          toast.innerHTML = `
            <div class="d-flex">
              <div class="toast-body">
                <i class="fas ${type === "success" ? "fa-check-circle" : "fa-exclamation-circle"}"></i>
                ${message}
              </div>
            </div>
          `;
          const toastContainer = document.getElementById('toastContainer');
          toastContainer.appendChild(toast);

          // Автоудаление через 3 сек
          setTimeout(() => {
            toast.classList.add('hide');
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        // Функция получения CSRF-токена (для Django)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
      });
    </script>

    <!-- Контейнер для уведомлений -->
    <div id="toastContainer" class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999;"></div>
  </body>
</html>