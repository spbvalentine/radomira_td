<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <title>Charts</title>
    <style>
        #loader {
            transition: all 0.3s ease-in-out;
            opacity: 1;
            visibility: visible;
            position: fixed;
            height: 100vh;
            width: 100%;
            background: #fff;
            z-index: 90000;
        }

        #loader.fadeOut {
            opacity: 0;
            visibility: hidden;
        }

        .spinner {
            width: 40px;
            height: 40px;
            position: absolute;
            top: calc(50% - 20px);
            left: calc(50% - 20px);
            background-color: #333;
            border-radius: 100%;
            -webkit-animation: sk-scaleout 1.0s infinite ease-in-out;
            animation: sk-scaleout 1.0s infinite ease-in-out;
        }

        @-webkit-keyframes sk-scaleout {
            0% { -webkit-transform: scale(0) }
            100% {
                -webkit-transform: scale(1.0);
                opacity: 0;
            }
        }

        @keyframes sk-scaleout {
            0% {
                -webkit-transform: scale(0);
                transform: scale(0);
            } 100% {
                  -webkit-transform: scale(1.0);
                  transform: scale(1.0);
                  opacity: 0;
              }
        }
    </style>
    <script defer="defer" src="/static/adminator/main.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="app">






<div id="loader">
    <div class="spinner"></div>
</div>

<script>
  // Функция для форматирования числа (1247 → 1 247)
  function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
  }

  // Загрузка статистики
  async function loadStats() {
    try {
      const response = await fetch('/api/stats/summary/');
      if (!response.ok) throw new Error('Ошибка сети');

      const data = await response.json();

      // Обновляем элементы
      document.getElementById('total-calls').innerHTML = `
        ${formatNumber(data.total_calls)}
        <i class="fa fa-level-up c-green-500"></i>
      `;
      document.getElementById('crisis-calls').innerHTML = `
        ${formatNumber(data.crisis_calls)}
        <i class="fa fa-level-down c-red-500"></i>
      `;
      document.getElementById('help-rate').textContent = `${data.help_rate_percent}%`;
      document.getElementById('avg-duration').textContent = `${data.avg_duration_minutes} мин`;

    } catch (error) {
      console.error('Ошибка загрузки статистики:', error);
      document.querySelectorAll('#total-calls, #crisis-calls, #help-rate, #avg-duration')
        .forEach(el => el.innerHTML = '<i class="fa fa-exclamation-triangle c-red-500"></i>');
    }
  }

  // Загружаем при старте
  window.addEventListener('load', loadStats);
    window.addEventListener('load', function load() {
        const loader = document.getElementById('loader');
        setTimeout(function() {
            loader.classList.add('fadeOut');
        }, 300);
    });
</script>



<div>
    <!-- #Left Sidebar ==================== -->
    <div class="sidebar">
        <div class="sidebar-inner">
            <!-- ### $Sidebar Header ### -->
            {% include 'adminator/logo.html' %}

            <!-- ### $Sidebar Menu ### -->
            {% include 'adminator/menu.html' %}
        </div>
    </div>

    <!-- #Main ============================ -->
    <div class="page-container">
        <!-- ### $Topbar ### -->
        {% include 'adminator/topbar.html' %}

        <!-- ### $App Screen Content ### -->
        <main class="main-content bgc-grey-100">
        <div id="mainContent">
          <div class="row gap-20 masonry pos-r">
            <div class="masonry-sizer col-md-6"></div>

            <!-- KPI Cards -->
            <div class="masonry-item w-100">
              <div class="row gap-20">
                <!-- Total Calls -->
                <div class="col-md-3">
                  <div class="layers bd bgc-white p-20">
                    <div class="layer w-100 mB-10">
                      <h6 class="lh-1">Всего звонков</h6>
                    </div>
                    <div class="layer w-100">
                      <div class="peers ai-sb fxw-nw">
                        <div class="peer peer-greed">
                          <span id="calls-sparkline">Loading...</span>
                        </div>
                        <div class="peer">
                          <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-green-50 c-green-500">+12%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Crisis Calls -->
                <div class="col-md-3">
                  <div class="layers bd bgc-white p-20">
                    <div class="layer w-100 mB-10">
                      <h6 class="lh-1">Кризисных звонков</h6>
                    </div>
                    <div class="layer w-100">
                      <div class="peers ai-sb fxw-nw">
                        <div class="peer peer-greed">
                          <span id="crisis-sparkline">Loading...</span>
                        </div>
                        <div class="peer">
                          <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-red-50 c-red-500">-5%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Help Provided -->
                <div class="col-md-3">
                  <div class="layers bd bgc-white p-20">
                    <div class="layer w-100 mB-10">
                      <h6 class="lh-1">Помощь оказана</h6>
                    </div>
                    <div class="layer w-100">
                      <div class="peers ai-sb fxw-nw">
                        <div class="peer peer-greed">
                          <span id="help-pie">Loading...</span>
                        </div>
                        <div class="peer">
                          <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-purple-50 c-purple-500">98%</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Avg Duration -->
                <div class="col-md-3">
                  <div class="layers bd bgc-white p-20">
                    <div class="layer w-100 mB-10">
                      <h6 class="lh-1">Средняя длительность</h6>
                    </div>
                    <div class="layer w-100">
                      <div class="peers ai-sb fxw-nw">
                        <div class="peer peer-greed">
                          <span id="duration-sparkline">Loading...</span>
                        </div>
                        <div class="peer">
                          <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-blue-50 c-blue-500">12 мин</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Main Chart + Top Stats -->
            <div class="masonry-item col-12">
              <div class="bd bgc-white">
                <div class="peers fxw-nw@lg+ ai-s">
                  <div class="peer peer-greed w-70p@lg+ w-100@lg- p-20">
                    <div class="layers">
                      <div class="layer w-100 mB-10">
                        <h6 class="lh-1">Динамика звонков за месяц</h6>
                      </div>
                      <div class="layer w-100">
                        <canvas id="calls-line-chart" height="220"></canvas>
                      </div>
                    </div>
                  </div>
                  <div class="peer bdL p-20 w-30p@lg+ w-100p@lg-">
                    <div class="layers">
                      <div class="layer w-100">
                        <h6 class="lh-1">ТОП-5 проблем</h6>
                        <div class="layers mT-15">
                          <div class="layer w-100">
                            <h5 class="mB-5">Депрессия</h5>
                            <small class="fw-600 c-grey-700">Проблема</small>
                            <span class="pull-right c-grey-600 fsz-sm">28%</span>
                            <div class="progress mT-10">
                              <div class="progress-bar bgc-deep-purple-500" role="progressbar" style="width:28%;"></div>
                            </div>
                          </div>
                          <div class="layer w-100 mT-15">
                            <h5 class="mB-5">Тревожность</h5>
                            <small class="fw-600 c-grey-700">Проблема</small>
                            <span class="pull-right c-grey-600 fsz-sm">22%</span>
                            <div class="progress mT-10">
                              <div class="progress-bar bgc-green-500" role="progressbar" style="width:22%;"></div>
                            </div>
                          </div>
                          <div class="layer w-100 mT-15">
                            <h5 class="mB-5">Семейные конфликты</h5>
                            <small class="fw-600 c-grey-700">Проблема</small>
                            <span class="pull-right c-grey-600 fsz-sm">18%</span>
                            <div class="progress mT-10">
                              <div class="progress-bar bgc-light-blue-500" role="progressbar" style="width:18%;"></div>
                            </div>
                          </div>
                          <div class="layer w-100 mT-15">
                            <h5 class="mB-5">Одиночество</h5>
                            <small class="fw-600 c-grey-700">Проблема</small>
                            <span class="pull-right c-grey-600 fsz-sm">15%</span>
                            <div class="progress mT-10">
                              <div class="progress-bar bgc-blue-grey-500" role="progressbar" style="width:15%;"></div>
                            </div>
                          </div>
                          <div class="layer w-100 mT-15">
                            <h5 class="mB-5">Финансовые трудности</h5>
                            <small class="fw-600 c-grey-700">Проблема</small>
                            <span class="pull-right c-grey-600 fsz-sm">12%</span>
                            <div class="progress mT-10">
                              <div class="progress-bar bgc-orange-500" role="progressbar" style="width:12%;"></div>
                            </div>
                          </div>
                        </div>

                        <div class="peers pT-20 mT-20 bdT fxw-nw@lg+ jc-sb ta-c gap-10">
                          <div class="peer">
                            <div class="easy-pie-chart" data-size="80" data-percent="75" data-bar-color="#f44336">
                              <span></span>
                            </div>
                            <h6 class="fsz-sm">Женщины</h6>
                          </div>
                          <div class="peer">
                            <div class="easy-pie-chart" data-size="80" data-percent="25" data-bar-color="#2196f3">
                              <span></span>
                            </div>
                            <h6 class="fsz-sm">Мужчины</h6>
                          </div>
                          <div class="peer">
                            <div class="easy-pie-chart" data-size="80" data-percent="40" data-bar-color="#ff9800">
                              <span></span>
                            </div>
                            <h6 class="fsz-sm">30-45 лет</h6>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Monthly Stats + Recent Calls List -->
            <div class="masonry-item col-md-6">
              <div class="bd bgc-white">
                <div class="layers">
                  <div class="layer w-100 pX-20 pT-20">
                    <h6 class="lh-1">Месячная статистика</h6>
                  </div>
                  <div class="layer w-100 p-20">
                    <canvas id="monthly-line-chart" height="220"></canvas>
                  </div>
                  <div class="layer bdT p-20 w-100">
                    <div class="peers ai-c jc-c gapX-20">
                      <div class="peer">
                        <span class="fsz-def fw-600 mR-10 c-grey-800">1247 <i class="fa fa-level-up c-green-500"></i></span>
                        <small class="c-grey-500 fw-600">Всего звонков</small>
                      </div>
                      <div class="peer fw-600">
                        <span class="fsz-def fw-600 mR-10 c-grey-800">312 <i class="fa fa-level-down c-red-500"></i></span>
                        <small class="c-grey-500 fw-600">Кризисных</small>
                      </div>
                      <div class="peer fw-600">
                        <span class="fsz-def fw-600 mR-10 c-grey-800">98% <i class="fa fa-level-up c-green-500"></i></span>
                        <small class="c-grey-500 fw-600">Помощь оказана</small>
                      </div>
                      <div class="peer fw-600">
                        <span class="fsz-def fw-600 mR-10 c-grey-800">12 мин <i class="fa fa-level-up c-orange-500"></i></span>
                        <small class="c-grey-500 fw-600">Сред. длительность</small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent Calls List -->
            <div class="masonry-item col-md-6">
              <div class="bd bgc-white p-20">
                <div class="layers">
                  <div class="layer w-100 mB-10">
                    <h6 class="lh-1">Последние звонки</h6>
                  </div>
                  <div class="layer w-100">
                    <ul class="list-task list-group" data-role="tasklist">
                      <li class="list-group-item bdw-0" data-role="task">
                        <div class="checkbox checkbox-circle checkbox-info peers ai-c">
                          <input type="checkbox" id="call1" name="calls" class="peer" disabled>
                          <label for="call1" class="form-label peers peer-greed js-sb ai-c" onclick="window.location='/calls/1247'">
                            <span class="peer peer-greed">Звонок #1247 — Депрессия, женщина 35 лет</span>
                            <span class="peer">
                              <span class="badge rounded-pill fl-r bg-danger lh-0 p-10">Кризис</span>
                            </span>
                          </label>
                        </div>
                      </li>
                      <li class="list-group-item bdw-0" data-role="task">
                        <div class="checkbox checkbox-circle checkbox-info peers ai-c">
                          <input type="checkbox" id="call2" name="calls" class="peer" disabled>
                          <label for="call2" class="form-label peers peer-greed js-sb ai-c" onclick="window.location='/calls/1246'">
                            <span class="peer peer-greed">Звонок #1246 — Тревожность, мужчина 28 лет</span>
                            <span class="peer">
                              <span class="badge rounded-pill fl-r bg-warning lh-0 p-10">Срочно</span>
                            </span>
                          </label>
                        </div>
                      </li>
                      <li class="list-group-item bdw-0" data-role="task">
                        <div class="checkbox checkbox-circle checkbox-info peers ai-c">
                          <input type="checkbox" id="call3" name="calls" class="peer" disabled>
                          <label for="call3" class="form-label peers peer-greed js-sb ai-c" onclick="window.location='/calls/1245'">
                            <span class="peer peer-greed">Звонок #1245 — Семейный конфликт, женщина 42 года</span>
                            <span class="peer">
                              <span class="badge rounded-pill fl-r bg-success lh-0 p-10">Решено</span>
                            </span>
                          </label>
                        </div>
                      </li>
                      <li class="list-group-item bdw-0" data-role="task">
                        <div class="checkbox checkbox-circle checkbox-info peers ai-c">
                          <input type="checkbox" id="call4" name="calls" class="peer" disabled>
                          <label for="call4" class="form-label peers peer-greed js-sb ai-c" onclick="window.location='/calls/1244'">
                            <span class="peer peer-greed">Звонок #1244 — Одиночество, пенсионер 68 лет</span>
                            <span class="peer">
                              <span class="badge rounded-pill fl-r bg-info lh-0 p-10">Повторный</span>
                            </span>
                          </label>
                        </div>
                      </li>
                      <li class="list-group-item bdw-0" data-role="task">
                        <div class="checkbox checkbox-circle checkbox-info peers ai-c">
                          <input type="checkbox" id="call5" name="calls" class="peer" disabled>
                          <label for="call5" class="form-label peers peer-greed js-sb ai-c" onclick="window.location='/calls/1243'">
                            <span class="peer peer-greed">Звонок #1243 — Финансовые трудности, мужчина 31 год</span>
                            <span class="peer">
                              <span class="badge rounded-pill fl-r bg-primary lh-0 p-10">Новый</span>
                            </span>
                          </label>
                        </div>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>

            <!-- Recent Calls Table -->
            <div class="masonry-item col-md-6">
              <div class="bd bgc-white">
                <div class="layers">
                  <div class="layer w-100 p-20">
                    <h6 class="lh-1">Последние звонки (таблица)</h6>
                  </div>
                  <div class="layer w-100">
                    <div class="table-responsive p-20">
                      <table class="table table-hover">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Дата</th>
                            <th>Проблема</th>
                            <th>Состояние</th>
                            <th>Консультант</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr onclick="window.location='/calls/1247'" style="cursor:pointer">
                            <td class="fw-600">#1247</td>
                            <td>15.04.2025</td>
                            <td>Депрессия</td>
                            <td><span class="badge bgc-red-50 c-red-700 p-10 lh-0 tt-c rounded-pill">Кризис</span></td>
                            <td>Иванова А.П.</td>
                          </tr>
                          <tr onclick="window.location='/calls/1246'" style="cursor:pointer">
                            <td class="fw-600">#1246</td>
                            <td>15.04.2025</td>
                            <td>Тревожность</td>
                            <td><span class="badge bgc-orange-50 c-orange-700 p-10 lh-0 tt-c rounded-pill">Срочно</span></td>
                            <td>Петров С.К.</td>
                          </tr>
                          <tr onclick="window.location='/calls/1245'" style="cursor:pointer">
                            <td class="fw-600">#1245</td>
                            <td>14.04.2025</td>
                            <td>Семейный конфликт</td>
                            <td><span class="badge bgc-green-50 c-green-700 p-10 lh-0 tt-c rounded-pill">Решено</span></td>
                            <td>Сидорова Е.В.</td>
                          </tr>
                          <tr onclick="window.location='/calls/1244'" style="cursor:pointer">
                            <td class="fw-600">#1244</td>
                            <td>14.04.2025</td>
                            <td>Одиночество</td>
                            <td><span class="badge bgc-blue-50 c-blue-700 p-10 lh-0 tt-c rounded-pill">Повторный</span></td>
                            <td>Иванова А.П.</td>
                          </tr>
                          <tr onclick="window.location='/calls/1243'" style="cursor:pointer">
                            <td class="fw-600">#1243</td>
                            <td>13.04.2025</td>
                            <td>Финансовые трудности</td>
                            <td><span class="badge bgc-purple-50 c-purple-700 p-10 lh-0 tt-c rounded-pill">Новый</span></td>
                            <td>Кузнецов Д.И.</td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="ta-c bdT w-100 p-20">
                    <a href="/calls/">Просмотреть все звонки</a>
                  </div>
                </div>
              </div>
            </div>

            <!-- Emotional State + Weekday Stats -->
            <div class="masonry-item col-md-6">
              <div class="bd bgc-white p-20">
                <div class="layers">
                  <div class="layer w-100 mB-20">
                    <h6 class="lh-1">Эмоциональный климат</h6>
                  </div>
                  <div class="layer w-100">
                    <div class="peers ai-c jc-sb fxw-nw">
                      <div class="peer peer-greed">
                        <div class="layers">
                          <div class="layer w-100">
                            <div class="peers fxw-nw ai-c">
                              <div class="peer mR-20">
                                <h3>78<sup>%</sup></h3>
                              </div>
                              <div class="peer">
                                <canvas id="emotion-pie" width="44" height="44"></canvas>
                              </div>
                            </div>
                          </div>
                          <div class="layer w-100">
                            <span class="fw-600 c-grey-600">в тревожном/депрессивном состоянии</span>
                          </div>
                        </div>
                      </div>
                      <div class="peer">
                        <div class="layers ai-fe">
                          <div class="layer">
                            <h5 class="mB-5">Сегодня</h5>
                          </div>
                          <div class="layer">
                            <span class="fw-600 c-grey-600">15.04.2025</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="layer w-100 mY-30">
                    <div class="layers bdB">
                      <div class="layer w-100 bdT pY-5">
                        <div class="peers ai-c jc-sb fxw-nw">
                          <div class="peer">
                            <span>Средний возраст</span>
                          </div>
                          <div class="peer ta-r">
                            <span class="fw-600 c-grey-800">38 лет</span>
                          </div>
                        </div>
                      </div>
                      <div class="layer w-100 bdT pY-5">
                        <div class="peers ai-c jc-sb fxw-nw">
                          <div class="peer">
                            <span>Повторных звонков</span>
                          </div>
                          <div class="peer ta-r">
                            <span class="fw-600 c-grey-800">15%</span>
                          </div>
                        </div>
                      </div>
                      <div class="layer w-100 bdT pY-5">
                        <div class="peers ai-c jc-sb fxw-nw">
                          <div class="peer">
                            <span>Удовлетворённость</span>
                          </div>
                          <div class="peer ta-r">
                            <span class="fw-600 c-grey-800">4.2/5</span>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="layer w-100">
                    <h6 class="mB-15">Звонки по дням недели</h6>
                    <div class="peers peers-greed ai-fs ta-c">
                      <div class="peer">
                        <h6 class="mB-10">ПН</h6>
                        <span class="d-b fw-600">127</span>
                      </div>
                      <div class="peer">
                        <h6 class="mB-10">ВТ</h6>
                        <span class="d-b fw-600">142</span>
                      </div>
                      <div class="peer">
                        <h6 class="mB-10">СР</h6>
                        <span class="d-b fw-600">138</span>
                      </div>
                      <div class="peer">
                        <h6 class="mB-10">ЧТ</h6>
                        <span class="d-b fw-600">151</span>
                      </div>
                      <div class="peer">
                        <h6 class="mB-10">ПТ</h6>
                        <span class="d-b fw-600">167</span>
                      </div>
                      <div class="peer">
                        <h6 class="mB-10">СБ</h6>
                        <span class="d-b fw-600">89</span>
                      </div>
                      <div class="peer">
                        <h6 class="mB-10">ВС</h6>
                        <span class="d-b fw-600">73</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Notes / Chat -->
            <div class="masonry-item col-md-6">
              <div class="bd bgc-white">
                <div class="layers">
                  <div class="layer w-100 p-20">
                    <h6 class="lh-1">Последние заметки консультантов</h6>
                  </div>
                  <div class="layer w-100">
                    <div class="bgc-grey-200 p-20 gapY-15">
                      <div class="peers fxw-nw">
                        <div class="peer mR-20">
                          <img class="w-2r bdrs-50p" src="https://randomuser.me/api/portraits/women/44.jpg" alt="Иванова А.П.">
                        </div>
                        <div class="peer peer-greed">
                          <div class="layers ai-fs gapY-5">
                            <div class="layer">
                              <div class="peers fxw-nw ai-c pY-3 pX-10 bgc-white bdrs-2 lh-3/2">
                                <div class="peer mR-10">
                                  <small>10:15</small>
                                </div>
                                <div class="peer-greed">
                                  <span><strong>Иванова А.П.</strong>: Звонок #1247 — клиент в остром кризисе, передан психологу дежурному.</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="peers fxw-nw ai-fe">
                        <div class="peer ord-1 mL-20">
                          <img class="w-2r bdrs-50p" src="https://randomuser.me/api/portraits/men/32.jpg" alt="Петров С.К.">
                        </div>
                        <div class="peer peer-greed ord-0">
                          <div class="layers ai-fe gapY-10">
                            <div class="layer">
                              <div class="peers fxw-nw ai-c pY-3 pX-10 bgc-white bdrs-2 lh-3/2">
                                <div class="peer mL-10 ord-1">
                                  <small>09:45</small>
                                </div>
                                <div class="peer-greed ord-0">
                                  <span><strong>Петров С.К.</strong>: #1246 — рекомендовано очное консультирование, клиент согласен.</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="peers fxw-nw">
                        <div class="peer mR-20">
                          <img class="w-2r bdrs-50p" src="https://randomuser.me/api/portraits/women/68.jpg" alt="Сидорова Е.В.">
                        </div>
                        <div class="peer peer-greed">
                          <div class="layers ai-fs gapY-5">
                            <div class="layer">
                              <div class="peers fxw-nw ai-c pY-3 pX-10 bgc-white bdrs-2 lh-3/2">
                                <div class="peer mR-10">
                                  <small>08:30</small>
                                </div>
                                <div class="peer-greed">
                                  <span><strong>Сидорова Е.В.</strong>: #1245 — семейный конфликт, даны рекомендации, клиент благодарен.</span>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    <div class="p-20 bdT bgc-white">
                      <div class="pos-r">
                        <input type="text" class="form-control bdrs-10em m-0" placeholder="Добавить заметку...">
                        <button type="button" class="btn btn-primary bdrs-50p w-2r p-0 h-2r pos-a r-1 t-1">
                          <i class="fa fa-paper-plane-o"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

        <!-- ### $App Screen Footer ### -->
        {% include 'adminator/bottombar.html' %}
    </div>
</div>
</body>
</html>